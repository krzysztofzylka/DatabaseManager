<?php

namespace krzysztofzylka\DatabaseManager\Trait;

use krzysztofzylka\DatabaseManager\DatabaseManager;
use krzysztofzylka\DatabaseManager\Exception\UpdateException;
use Exception;

trait TableUpdate {

    /**
     * Update
     * @param array $data
     * @return bool
     * @throws UpdateException
     */
    public function update(array $data) : bool {
        if (is_null($this->getName())) {
            throw new UpdateException('Table is not defined');
        } elseif (is_null($this->getId())) {
            throw new UpdateException('ID is not defined');
        }

        $set = [];

        foreach (array_keys($data) as $name) {
            $set[] = '`' . $name . '` = :' . $name;
        }

        try {
            $sql = 'UPDATE `' . $this->getName() . '` SET ' . implode(', ', $set) . ' WHERE id=' . $this->getId();
            DatabaseManager::setLastSql($sql);
            $update = $this->pdo->prepare($sql);

            foreach ($data as $name => $value) {
                $update->bindValue(':' . $name, $value);
            }

            return $update->execute();
        } catch (Exception $exception) {
            throw new UpdateException($exception->getMessage());
        }
    }

    /**
     * Update single column
     * @param string $columnName
     * @param mixed $value
     * @return bool
     * @throws UpdateException
     */
    public function updateValue(string $columnName, mixed $value) : bool {
        if (is_null($this->getName())) {
            throw new UpdateException('Table is not defined');
        } elseif (is_null($this->getId())) {
            throw new UpdateException('ID is not defined');
        }

        try {
            $sql = 'UPDATE `' . $this->getName() . '` SET `' . $columnName . '` = :' . $columnName . ' WHERE id=' . $this->getId();
            DatabaseManager::setLastSql($sql);
            $update = $this->pdo->prepare($sql);
            $update->bindValue(':' . $columnName, $value);

            return $update->execute();
        } catch (Exception $exception) {
            throw new UpdateException($exception->getMessage());
        }
    }

}